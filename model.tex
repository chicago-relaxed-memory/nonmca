\section{Model}

\begin{align*}
  \amode \BNFDEF& \mWK &&\text{{(Weak)}}                      &\ascope \BNFDEF& \sCTA &&\text{(Thread group)} &\hbox{$\;\mkern60mu\;$}&
  \\[-1ex] \BNFSEP& \mRLX &&\text{{(Relaxed)}}                & \BNFSEP&\sGPU   &&\text{(Processor)}                                   
  \\[-1ex] \BNFSEP& \mRA &&\text{{(Release/Acquire)}}         & \BNFSEP&\sSYS  &&\text{(System)}                                         
  \\[-1ex] \BNFSEP& \mSC &&\text{{(Sequentially Consistent)}}    
\end{align*}

Orders/Relations in model
\begin{itemize}
\item $\lestrong$ is the old $\le$ (without coherence stuff from \ref{rf4} and \ref{5b}).

  This provides the NO-TAR axiom.
\item $\le$ is a suborder, which only includes $\rrf$ when they are morally strong.

  This serves as a cross-location transitive kernel for the per-location order.
  
\item $\lesc$ is a per-location order that relates morally strong  and $\rpoloc$ accesses

  This includes $\le$ for  morally strong accesses.

  This provides the SC-PER-LOC axiom.

  % \item $\rrmw$ is a per-location relation on actions in an \RMW{}
\end{itemize}

% Write $\bEv\conflict\aEv$ if they conflict (ie, read/write or write/write, same location).

% Write $\bEv\moral\aEv$ if they conflict and are morally strong

\begin{definition}
  A \emph{pomset with preconditions} is a tuple
  $(\Event, \labeling, {\le}, {\lestrong}, {\lesc})$ where
  \begin{description}
  \item[{\labeltextsc[m1]{(m1)}{m1}}] $\Event$ is a set of \emph{events}
  \item[{\labeltextsc[m2]{(m2)}{m2}}]
    $\labeling: \Event \fun (\Formulae\times\Act)$ is a \emph{labeling} from
    which we derive functions
    \begin{itemize}
    \item $\labelingForm:\Event\fun\Formulae$
      \emph{(formulae)} % include $r{=}v$ $x{=}v$
    \item $\labelingAct:\Event\fun\Act$
      \emph{(actions)} %include $\DW{x}{v}$, $\DR{x}{v}$, and $\DSTOP$
    \end{itemize}
  \item[{\labeltextsc[m3]{(m3)}{m3}}]
    ${\le} \subseteq (\Event\times\Event)$,
    ${\lestrong} \subseteq (\Event\times\Event)$, and
    ${\lesc} \subseteq (\Event\times\Event)$ are partial orders
  \item[{\labeltextsc[m4]{(m4)}{m4}}] if $\bEv\le\aEv$ then $\bEv\lestrong\aEv$
  \item[{\labeltextsc[m5]{(m5)}{m5}}] if $\bEv\le\aEv$ and $\bEv$ conflicts
    with $\aEv$ then $\bEv\lesc\aEv$
  \item[{\labeltextsc[m6]{(m6)}{m6}}] $\bigwedge_{\aEv}\labelingForm(\aEv)$
    is satisfiable \emph{(consistency)}
  \item[{\labeltextsc[m7]{(m7)}{m7}}] if $\bEv\lestrong\aEv$ then
    $\labelingForm(\aEv)$ implies $\labelingForm(\bEv)$ \emph{(causal
      strengthening)}
  \end{description}
\end{definition}
It is important that \ref{m5} covers all conflicting access.
See \ref{pub1sys}.


\begin{definition}
  We say $\bEv\lt\aEv$ when $\bEv\le\aEv$ and $\bEv\neq\aEv$, and similarly
  for $\ltstrong$ and $\ltsc$.

  Define $\leloc$ and $\ltloc$ as follows:
  \begin{align*}
    \bEv\leloc\aEv &\textwhen                      
    \begin{cases}
      \bEv\lesc\aEv &\text{if}\; \bEv \;\text{is morally strong with}\;
      \aEv %\bEv\moral\aEv
      \\
      \aEv\not\ltsc\bEv &\text{otherwise}
    \end{cases}
    \\
    \bEv\ltloc\aEv &\textwhen                      
    \begin{cases}
      \bEv\ltsc\aEv &\text{if}\; \bEv \;\text{is morally strong with}\;
      \aEv %\bEv\moral\aEv
      \\
      \aEv\not\lesc\bEv &\text{otherwise}
    \end{cases}
  \end{align*}
\end{definition}


\begin{definition}
  We say $\labelingAct(\bEv)=(\DW[]{x}{v})$ \emph{fulfills}
  $\labelingAct(\aEv)=(\DR[]{x}{v})$ if
  \begin{description}
  \item[{\labeltextsc[F3]{(F3)}{rf3}}] $\bEv \ltloc \aEv$ and
    $\bEv \lestrong \aEv$
  \item[{\labeltextsc[F4]{(F4)}{rf4}}]
    $\forall\labelingAct(\cEv)=(\DW[]{x}{..})$ either $\cEv \leloc \bEv$ or
    $\aEv \leloc \cEv$
  \end{description}
  
\end{definition}

Note that if all accesses are morally strong with each other, this
degenerates to
\begin{description}
\item[\eqref{rf3}]
  $\bEv \ltsc \aEv$
  and $\bEv \lestrong \aEv$
\item[\eqref{rf4}]
  $\forall\labelingAct(\cEv)=(\DW[]{x}{..})$ either
  $\cEv \lesc \bEv$ or $\aEv \lesc \cEv$
\end{description}

If no accesses are morally strong with each other, this degenerates to
\begin{description}
\item[\eqref{rf3}]
  $\aEv \not\ltsc \bEv$
  and $\bEv \lestrong \aEv$
\item[\eqref{rf4}]
  $\not\mkern-5mu\exists\labelingAct(\cEv)=(\DW[]{x}{..})$ 
  both $\bEv \lesc \cEv$ and $\cEv \lesc \aEv$
\end{description}
\begin{definition}
  Let $\aPS'\in(\aForm \mid \aAct) \prefix \aPSS$ when
  $(\exists\aPS\in\aPSS)$ $(\forall\aEv\in\Event)$
  \begin{description}
  \item[{\labeltextsc[P1]{(P1)}{1}}] $\Event' = \Event \cup \{\bEv\}$
  \item[{\labeltextsc[P2]{(P2)}{2}}] ${\le'}\supseteq{\le}$,
    ${\lestrong'}\supseteq{\lestrong}$, and ${\lesc'}\supseteq{\lesc}$
  \item[{\labeltextsc[P3]{(P3a)}{3a}\labeltextsc[P3]{}{3}}]%
    $\labelingAct'(\aEv) = \labelingAct(\aEv)$
  \item[{\labeltextsc[P3b]{(P3b)}{3b}}] $\labelingAct'(\bEv) = \aAct$
  \item[{\labeltextsc[P4a]{(P4a)}{4a}\labeltextsc[P4]{}{4}}]%
    $\labelingForm'(\bEv)$ implies
    $\aForm\land(\bEv\not\in\Event\lor\labelingForm(\bEv))$
  \item[{\labeltextsc[P4b]{(P4b)}{4b}}] if $\bEv\neq(\DR[]{..)}{}\mkern86mu$
    then $\aEv=\bEv$ or $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)$
  \item[{\labeltextsc[P4c]{(P4c)}{4c}}] if
    $\bEv=(\DR[]{\aVal}{\aLoc})\mkern75mu$ then $\aEv=\bEv$ or
    $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)[\aVal/\aLoc]$
  \item[{\labeltextsc[P5a]{(P5a)}{5a}\labeltextsc[P5]{}{5}}]%
    if $\bEv=(\DR[]{..)}{}$, $\aEv=(\DW[]{..)}{}$ then $\aEv=\bEv$ or
    $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)$ or $\bEv\le'\aEv$
  \item[{\labeltextsc[P5b]{(P5b)}{5b}}] if $\bEv$ conflicts with
    $\aEv$ %$\bEv\conflict\aEv$
    then $\bEv\lesc'\aEv$
  \item[{\labeltextsc[P5c]{(P5c)}{5c}}] if $\bEv$ is an acquire or $\aEv$ is
    a release then $\bEv \le' \aEv$
  \item[{\labeltextsc[P5d]{(P5d)}{5d}}] if $\bEv$ is an SC write and $\aEv$
    is an SC read then $\bEv \le' \aEv$
    % \item[{\labeltextsc[P5e]{(P5e)}{5e}}] if $\bEv$ reads, and $\aEv$ is an
    %   acquiring fence, then
    %   $\bEv \le' \aEv$
    % \item[{\labeltextsc[P5f]{(P5f)}{5f}}] if $\bEv$ is a releasing fence,
    %   and $\aEv$ writes, then
    %   $\bEv \le' \aEv$
  \end{description}
\end{definition}

\section{Examples}
Unless otherwise stated, all threads in different $\sCTA$s.

Default scope is $\sCTA$.

Default mode is $\mWK$.

$(\DR{x}{0})$ must be forbidden.
Before fulfilling the read:
\begin{gather*}
  \taglabel[sys]{pub1}
  \PW{x}{0}\SEMI 
  \PW{x}{1}\SEMI
  \PW[\mRA][\sSYS]{y}{1} \PAR
  \PR[\mRA][\sSYS]{y}{r}\SEMI
  \PR{x}{s}
  \\
  \tag{${\lestrong}={\le}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA][\sSYS]{y}{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA][\sSYS]{y}{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      \sync[out=-15,in=-165]{wx0}{wy1}
      \sync{wx1}{wy1}
      \sync{ry1}{rx}
      \rf{wy1}{ry1}
    \end{tikzinline}}
  \\
  \tag{$\lesc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA][\sSYS]{y}{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA][\sSYS]{y}{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      \rf{wy1}{ry1}
      \wk{wx0}{wx1}
      \wk[out=-15,in=-165]{wx1}{rx}
    \end{tikzinline}}
\end{gather*}
$(\DW{x}{1})\leloc(\DR{x}{})$ is required by \ref{m5}, enforcing publication.

$(\DR{x}{0})$ must be allowed:
\begin{gather*}
  \taglabel[cta]{pub1}
  \PW{x}{0}\SEMI 
  \PW{x}{1}\SEMI
  \PW[\mRA]{y}{1} \PAR
  \PR[\mRA]{y}{r}\SEMI
  \PR{x}{s}
  \\
  \tag{${\lestrong}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA]{y}{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA]{y}{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      \sync[out=-15,in=-165]{wx0}{wy1}
      \sync{wx1}{wy1}
      \sync{ry1}{rx}
      \rf{wy1}{ry1}
    \end{tikzinline}}
  \\
  \tag{${\le}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA]{y}{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA]{y}{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      \sync[out=-15,in=-165]{wx0}{wy1}
      \sync{wx1}{wy1}
      \sync{ry1}{rx}
      % \rf{wy1}{ry1}
    \end{tikzinline}}
  \\
  \tag{$\lesc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA]{y}{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA]{y}{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      % \rf{wy1}{ry1}
      \wk{wx0}{wx1}
      % \wk[out=-15,in=-165]{wx1}{rx}
    \end{tikzinline}}
\end{gather*}
We do not have $(\DW[\mRA]{y}{1})\le (\DR[\mRA]{y}{1})$ since \ref{rf3} only
requires order for things that are morally strong.  

Another example that may be of interest (nothing morally strong).  Can this $(\DR{x}{0})$?
\begin{gather*}
  %\taglabel[cta]{pub1}
  \PW{x}{0} \SEMI
  \PW{x}{1} \PAR 
  \PWR{y}{x} \PAR
  \IF{\PR{y}{}}\THEN \PR{x}{r} \FI
\end{gather*}

PTX allows TC16 for events that are not mutually strong
\begin{gather*}
  \taglabel[wk]{TC16}
  \PR{x}{r} \SEMI \PW{x}{1}
  \PAR
  \PR{x}{s} \SEMI \PW{x}{2}
  \\
  \tag{$\lestrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR{x}{2}}{}
      \event{a2}{\DW{x}{1}}{right=of a1}
      \event{b1}{\DR{x}{1}}{right=3em of a2}
      \event{b2}{\DW{x}{2}}{right=of b1}
      \rf{a2}{b1}
      \rf[out=-165,in=-15]{b2}{a1}
    \end{tikzinline}}
  \\
  \tag{$\le$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR{x}{2}}{}
      \event{a2}{\DW{x}{1}}{right=of a1}
      \event{b1}{\DR{x}{1}}{right=3em of a2}
      \event{b2}{\DW{x}{2}}{right=of b1}
    \end{tikzinline}}
  \\
  \tag{$\lesc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR{x}{2}}{}
      \event{a2}{\DW{x}{1}}{right=of a1}
      \event{b1}{\DR{x}{1}}{right=3em of a2}
      \event{b2}{\DW{x}{2}}{right=of b1}
      \wk{a1}{a2}
      \wk{b1}{b2}
      % \rf{a2}{b1}
      % \rf[out=-165,in=-15]{b2}{a1}
    \end{tikzinline}}
\end{gather*}
Note that $\le$ imposes no requirements here.  Fulfillment imposes no order.
\begin{gather*}
  \taglabel[sys]{TC16}
  \PR[\mRLX][\sSYS]{x}{r} \SEMI \PW[\mRLX][\sSYS]{x}{1}
  \PAR
  \PR[\mRLX][\sSYS]{x}{s} \SEMI \PW[\mRLX][\sSYS]{x}{2}
  \\
  \tag{${\lestrong}={\le}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR[\mRLX][\sSYS]{x}{2}}{}
      \event{a2}{\DW[\mRLX][\sSYS]{x}{1}}{right=of a1}
      \event{b1}{\DR[\mRLX][\sSYS]{x}{1}}{right=3em of a2}
      \event{b2}{\DW[\mRLX][\sSYS]{x}{2}}{right=of b1}
      \rf{a2}{b1}
      \rf[out=-165,in=-15]{b2}{a1}
    \end{tikzinline}}
  \\
  \tag{$\lesc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR[\mRLX][\sSYS]{x}{2}}{}
      \event{a2}{\DW[\mRLX][\sSYS]{x}{1}}{right=of a1}
      \event{b1}{\DR[\mRLX][\sSYS]{x}{1}}{right=3em of a2}
      \event{b2}{\DW[\mRLX][\sSYS]{x}{2}}{right=of b1}
      \wk{a1}{a2}
      \wk{b1}{b2}
      \rf{a2}{b1}
      \rf[out=-165,in=-15]{b2}{a1}
    \end{tikzinline}}
\end{gather*}


\section{More Model}
\begin{definition}
  A pomset is \emph{$\aLoc$-closed} if
  \begin{itemize}
  \item every $\labelingAct(\aEv)=(\DR{\aLoc}{..})$ is fulfilled
  \item every $\labelingForm(\aEv)$ is independent of $x$:
    $\bigl(\forall v.\;\labelingForm(\aEv) \vDash
    \labelingForm(\aEv)[\aVal/\aLoc] \vDash \labelingForm(\aEv)\bigr)$
  \end{itemize}
\end{definition}

\begin{definition}
  Let $\aPS\phantom{'}\in(\nu\aLoc\!\DOT\!\aPSS) \mkern22mu$ when
  $\phantom{(\exists}\aPS\in\aPSS$ and $\aPS$ is $\aLoc$-closed
\end{definition}
\begin{definition}
  Let $\aPS\phantom{'}\in(\aForm \guard \aPSS)\mkern16mu$ when
  $\phantom{(\exists}\aPS\in\aPSS$ and $(\forall\aEv\in\Event)$
  $\labelingForm(\aEv)$ implies $\aForm$
\end{definition}

\begin{definition}
  Let $\aPS'\in(\aPSS[M/x])\mkern2mu$ when $(\exists\aPS\in\aPSS$)\\\qquad
  $\Event' = \Event$, ${\le'} = {\le}$, $\labelingAct' = \labelingAct$, and
  $(\forall\aEv\in\Event')$ $\labelingForm'(\aEv) = \labelingForm(\aEv)[M/x]$
\end{definition}
\begin{definition}
  Let $\aPS' \in (\aPSS^1 \parallel \aPSS^2)$ when
  $(\exists\aPS^1 \in \aPSS^1)$ $(\exists\aPS^2 \in \aPSS^2)$
  \\% $\aPS^1$ is completed exactly when $\aPS^2$ is completed, there is at most one termination in $\Event'$,
  \qquad $\Event' = \Event^1 \cup \Event^2$,
  ${\le'}\supseteq{\le^1}\cup{\le^2}$, and $(\forall\aEv\in\Event')$ either
  \begin{gather*}
    \begin{aligned}
      \aEv \not\in \Event^2,\; \labelingAct'(\aEv) &= \labelingAct^1(\aEv)
      \textand \labelingForm'(\aEv) \textimplies \labelingForm^1(\aEv),
      \\[-1ex]
      \aEv \not\in \Event^1,\; \labelingAct'(\aEv) &= \labelingAct^2(\aEv)
      \textand \labelingForm'(\aEv) \textimplies
      \labelingForm^2(\aEv),\textor
      \\[-1ex]
      \labelingAct'(\aEv) = \labelingAct^1(\aEv) &= \labelingAct^2(\aEv)
      \textand \labelingForm'(\aEv) \textimplies \labelingForm^1(\aEv) \lor
      \labelingForm^2(\aEv)
    \end{aligned}
  \end{gather*}
\end{definition}

Language
\begin{gather*}
  % \begin{aligned}
  %   \aCmd,\,\bCmd
  %   \BNFDEF& \SKIP
  %   \BNFSEP \aReg\GETS\aExp\SEMI \aCmd
  %   \BNFSEP \aReg\GETS\aLoc^{\amode}\SEMI \aCmd 
  %   \BNFSEP \aLoc^{\amode}\GETS\aExp\SEMI \aCmd
  %   \\[-.5ex]
  %   \BNFSEP&\aCmd \PAR[\aThrd][\bThrd] \bCmd
  %   \BNFSEP \VAR\aLoc\SEMI \aCmd
  %   \BNFSEP \IF{\aExp} \THEN \aCmd \ELSE \bCmd \FI
  % \end{aligned}
  % \\
  \begin{aligned}
    \sem[\aThrd]{\SKIP} & \eqdef
    \{ \DSTOP \}
    \\
    \sem[\aThrd]{\aReg\GETS\aExp\SEMI \aCmd} & \eqdef
    \sem[\aThrd]{\aCmd}[\aExp/\aReg]
    \\ 
    \sem{\aReg\GETS\aLoc^{\amode}\SEMI \aCmd} & \eqdef \textstyle\bigcup_\aVal\;
    (\DR[\amode]\aLoc\aVal)\prefix \sem{\aCmd} [\aLoc/\aReg]
    \\
    \sem{\aLoc^{\amode}\GETS\aExp\SEMI \aCmd} & \eqdef
    \textstyle\bigcup_\aVal\; (\aExp=\aVal \mid \DW[\amode]\aLoc\aVal)\prefix \sem{\aCmd}[\aExp/\aLoc]
    \\
    \sem{\FENCE^{\fmode}\SEMI \aCmd} & \eqdef
    (\DFS{\fmode}) \prefix \sem{\aCmd}
    \\
    \sem[\aThrd]{\IF{\aExp} \THEN \aCmd \ELSE \bCmd \FI} & \eqdef
    \bigl(\aExp \guard \sem[\aThrd]{\aCmd}\bigr) \parallel \bigl(\lnot\aExp \guard \sem[\aThrd]{\bCmd}\bigr) 
    \\
    \sem[\aThrd]{\aCmd \PAR[\bThrd][\bThrd'] \bCmd} & \eqdef
    \sem[\bThrd]{\aCmd} \parallel \sem[\bThrd']{\bCmd} 
    \\
    \sem[\aThrd]{\VAR\aLoc\SEMI \aCmd} & \eqdef
    \nu \aLoc \DOT \sem[\aThrd]{\aCmd}  
  \end{aligned}
\end{gather*}
\begin{align*}
  \fmode \BNFDEF&\mREL  &&\text{(Release)} &\hbox{$\;\mkern60mu\;$}&
  \\ \BNFSEP&\mACQ   &&\text{(Acquire)} 
  \\      \BNFSEP&\mSC  &&\text{(SC)} 
\end{align*}

