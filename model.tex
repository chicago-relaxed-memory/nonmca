\section{Model}

Four orders
\begin{itemize}
\item $\les$ is the old $\le$ (without coherence stuff from \ref{rf4} and \ref{5b}).

  This provides the NO-TAR axiom.
\item $\lew$ is a suborder, which only includes $\rrf$ when they are mutually strong.

  This serves as a cross-location transitive kernel for the per-location orders.
  
\item $\lesc$ is a per-location order, that only relates morally strong accesses

  This includes $\lew$ for mutually strong accesses
\item $\leobs$ is a per-location order, that only relates all accesses

  This includes $\lew$ for all accesses
\end{itemize}

Write $\bEv\conflict\aEv$ if they conflict (ie, read/write or write/write, same location).

Write $\bEv\mutstrong\aEv$ if they conflict and are mutually strong

  \begin{itemize}
  \item A \emph{pomset with preconditions} is a tuple
    $(\Event, {\les}, {\lew}, {\leobs}, {\lesc}, \labeling)$ where
    \begin{itemize}
    \item $\Event$ is a set of \emph{events}
    \item ${\les} \subseteq (\Event\times\Event)$,
      ${\lew} \subseteq (\Event\times\Event)$, 
      ${\lesc} \subseteq (\Event\times\Event)$, and
      ${\leobs} \subseteq (\Event\times\Event)$ are partial orders
    \item $\labeling: \Event \fun (\Formulae\times\Act)$ is a \emph{labeling}
      from which we derive functions
      \begin{itemize}
      \item $\labelingForm:\Event\fun\Formulae$ \emph{(formulae)} % include $r{=}v$  $x{=}v$
      \item $\labelingAct:\Event\fun\Act$  \emph{(actions)} %include $\DW{x}{v}$, $\DR{x}{v}$, and $\DSTOP$
      \end{itemize}
    \item $\bigwedge_{\aEv}\labelingForm(\aEv)$ is satisfiable
      \emph{(consistency)}
    \item if $\bEv\les\aEv$ then $\labelingForm(\aEv)$ implies
      $\labelingForm(\bEv)$ \emph{(causal strengthening)}
    \item if $\bEv\lew\aEv$ then $\bEv\les\aEv$ 
    \item if $\bEv\lew\aEv$ and $\bEv\conflict\aEv$ then $\bEv\leobs\aEv$ 
    \item if $\bEv\lew\aEv$ and $\bEv\mutstrong\aEv$ then $\bEv\lesc\aEv$ 
    \end{itemize}
  \item
    We say $\labelingAct(\bEv)=(\DW{x}{v})$ \emph{fulfills} $\labelingAct(\aEv)=(\DR{x}{v})$ if 
    % We say $\bEv$ \emph{fulfills $\aEv$} if 
    % % \labeltextsc[F1]{(F1)}{rf1}
    % $\labelingAct(\bEv)=\DW{x}{v}$,
    % % \labeltextsc[F2]{(F2)}{rf2}
    % $\labelingAct(\aEv)=\DR{x}{v}$,
    \begin{itemize}
      % \item[{\labeltextsc[F1]{(F1)}{rf1}}] $\labelingAct(\bEv)=\DW{x}{v}$,
      % \item[{\labeltextsc[F2]{(F2)}{rf2}}] $\labelingAct(\aEv)=\DR{x}{v}$,
    \item[{\labeltextsc[F3]{(F3)}{rf3}}]
      $\bEv \lts \aEv$
    \item[{\labeltextsc[F3]{(F3)}{rf3}}]
      if $\bEv \mutstrong \aEv$ then $\bEv \ltw \aEv$
    \item[{\labeltextsc[F4]{(F4)}{rf4}}]
      if $\labelingAct(\cEv)=(\DW{x}{..})$ then either
      \begin{itemize}
      \item $\cEv \leobs \bEv$ or
      \item $\aEv \leobs \cEv$
    \end{itemize}
    \item[{\labeltextsc[F4]{(F4)}{rf4}}]
      if $\labelingAct(\cEv)=(\DW{x}{..})$ then either  (something like this)
      \begin{itemize}
      \item $\cEv\mutstrong\bEv$ implies $\cEv \lesc \bEv$ or
      \item $\aEv\mutstrong\cEv$ implies $\aEv \lesc \cEv$      
      \end{itemize}
    \end{itemize}

  \item Let $\aPS'\in(\aForm \mid \aAct) \prefix \aPSS$ when
    $(\exists\aPS\in\aPSS)$
    $(\forall\aEv\in\Event)$
    \begin{enumerate}
    \item[{\labeltextsc[P1]{(P1)}{1}}]
      $\Event' = \Event \cup \{\bEv\}$
    \item[{\labeltextsc[P2]{(P2)}{2}}]
      ${\les'}\supseteq{\les}$,
      ${\lew'}\supseteq{\lew}$,
      ${\lesc}\supseteq{\lesc}$,
      ${\leobs'}\supseteq{\leobs}$,
    \item[{\labeltextsc[P3]{(P3a)}{3a}\labeltextsc[P3]{}{3}}]%
      $\labelingAct'(\aEv) = \labelingAct(\aEv)$
    \item[{\labeltextsc[P3b]{(P3b)}{3b}}]
      $\labelingAct'(\bEv) = \aAct$
    \item[{\labeltextsc[P4a]{(P4a)}{4a}\labeltextsc[P4]{}{4}}]%
      $\labelingForm'(\bEv)$ implies $\aForm\land(\bEv\not\in\Event\lor\labelingForm(\bEv))$
      % \\
      % if $\bEv\not\in\Event$ then $\labelingForm'(\bEv)$ implies
      % $\aForm$;
      % if $\bEv\in\Event$ then $\labelingForm'(\bEv)$ implies
      % $\aForm\lor\labelingForm(\bEv)$;
    \item[{\labeltextsc[P4b]{(P4b)}{4b}}]
      if $\bEv\neq(\DR{..)}{}\mkern86mu$ then $\aEv=\bEv$ or $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)$
    \item[{\labeltextsc[P4c]{(P4c)}{4c}}]
      if $\bEv=(\DR{\aVal}{\aLoc})\mkern75mu$ then $\aEv=\bEv$ or $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)[\aVal/\aLoc]$
    \item[{\labeltextsc[P5a]{(P5a)}{5a}\labeltextsc[P5]{}{5}}]%
      if $\bEv=(\DR{..)}{}$, $\aEv=(\DW{..)}{}$ then $\aEv=\bEv$ or $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)$ or $\bEv\lew'\aEv$
    \item[{\labeltextsc[P5b]{(P5b)}{5b}}]
      if $\bEv\conflict\aEv$ then $\bEv\leobs'\aEv$\\
      if $\bEv\mutstrong\aEv$ then $\bEv\lesc'\aEv$
    \item[{\labeltextsc[P5c]{(P5c)}{5c}}]
      if $\bEv$ is an acquire or $\aEv$ is a release then $\bEv \lew' \aEv$
    \item[{\labeltextsc[P5d]{(P5d)}{5d}}]
      if $\bEv$ is an SC write and $\aEv$ is an SC read then $\bEv \lew' \aEv$
    % \item[{\labeltextsc[P5e]{(P5e)}{5e}}] if $\bEv$ reads, and $\aEv$ is an acquiring fence, then
    %   $\bEv \lew' \aEv$
    % \item[{\labeltextsc[P5f]{(P5f)}{5f}}] if $\bEv$ is a releasing fence, and $\aEv$ writes, then
    %   $\bEv \lew' \aEv$
    \end{enumerate}
  \end{itemize}

  \clearpage
  \begin{itemize}
  \item
    A pomset is \emph{$\aLoc$-closed} if
    \begin{itemize}
    \item every $\labelingAct(\aEv)=(\DR{\aLoc}{..})$ is fulfilled
    \item every $\labelingForm(\aEv)$ is independent of $x$: $\bigl(\forall v.\;\labelingForm(\aEv) \vDash \labelingForm(\aEv)[\aVal/\aLoc] \vDash
      \labelingForm(\aEv)\bigr)$
    \end{itemize}
  \item
    Let $\aPS\phantom{'}\in(\nu\aLoc\!\DOT\!\aPSS) \mkern22mu$ when $\phantom{(\exists}\aPS\in\aPSS$
    and $\aPS$ is $\aLoc$-closed
    % Let $(\nu\aLoc\!\DOT\!\aPSS)$ be  $\aPSS'\subseteq\aPSS$ where $\aPS'\in\aPSS'$
    % when $\aPS'$ is $\aLoc$-closed
  \item 
    % Let $(\aForm \guard \aPSS)$ be the set $\aPSS'\subseteq\aPSS$ where
    % $\aPS'\in\aPSS'$ when $\labelingForm(\aEv')$ implies $\aForm$
    Let $\aPS\phantom{'}\in(\aForm \guard \aPSS)\mkern16mu$ when $\phantom{(\exists}\aPS\in\aPSS$ and 
    $(\forall\aEv\in\Event)$ $\labelingForm(\aEv)$ implies $\aForm$
  \item 
    Let $\aPS'\in(\aPSS[M/x])\mkern2mu$ when
    $(\exists\aPS\in\aPSS$)\\\qquad $\Event' = \Event$, ${\le'} = {\le}$,
    $\labelingAct' = \labelingAct$, and
    $(\forall\aEv\in\Event')$ $\labelingForm'(\aEv) = \labelingForm(\aEv)[M/x]$
    % % Let $(\aPSS\aSub)$
    % Let $(\aPSS[M/x])$
    % be the set $\aPSS'$ where $\aPS'\in\aPSS'$ when there is
    % $\aPS\in\aPSS$ where\\ $\Event' = \Event$, ${\le'} = {\le}$,
    % $\labelingAct' = \labelingAct$, and
    % $\labelingForm'(\aEv) = \labelingForm(\aEv)[M/x]$
    % % $\labelingForm'(\aEv) = \labelingForm(\aEv)\aSub$
  \item 
    Let $\aPS' \in (\aPSS^1 \parallel \aPSS^2)$ when
    $(\exists\aPS^1 \in \aPSS^1)$ $(\exists\aPS^2 \in \aPSS^2)$
    \\% $\aPS^1$ is completed exactly when $\aPS^2$ is completed, there is at most one termination in $\Event'$,
    \qquad $\Event' = \Event^1 \cup \Event^2$,
    ${\le'}\supseteq{\le^1}\cup{\le^2}$, and $(\forall\aEv\in\Event')$ either
    \begin{gather*}
      \begin{aligned}
        \aEv \not\in \Event^2,\; \labelingAct'(\aEv) &= \labelingAct^1(\aEv) \textand \labelingForm'(\aEv) \textimplies \labelingForm^1(\aEv),
        \\[-1ex]
        \aEv \not\in \Event^1,\; \labelingAct'(\aEv) &= \labelingAct^2(\aEv) \textand \labelingForm'(\aEv) \textimplies \labelingForm^2(\aEv),\textor
        \\[-1ex]
        \labelingAct'(\aEv) = \labelingAct^1(\aEv) &= \labelingAct^2(\aEv) \textand \labelingForm'(\aEv) \textimplies \labelingForm^1(\aEv) \lor \labelingForm^2(\aEv)
      \end{aligned}
    \end{gather*}
    % \begin{itemize}
    % \item $\labelingAct'(\aEv) = \labelingAct^1(\aEv) = \labelingAct^2(\aEv) \textand \labelingForm'(\aEv) \textimplies \labelingForm^1(\aEv) \lor \labelingForm^2(\aEv),$
    % \item $\aEv \not\in \Event^2,\; \labelingAct'(\aEv) = \labelingAct^1(\aEv) \textand \labelingForm'(\aEv) \textimplies \labelingForm^1(\aEv),$ or
    % \item $\aEv \not\in \Event^1,\; \labelingAct'(\aEv) = \labelingAct^2(\aEv) \textand \labelingForm'(\aEv) \textimplies \labelingForm^2(\aEv)$.
    % \end{itemize}
  \end{itemize}

  Language
  \begin{gather*}
    % \begin{aligned}
    %   \aCmd,\,\bCmd
    %   \BNFDEF& \SKIP
    %   \BNFSEP \aReg\GETS\aExp\SEMI \aCmd
    %   \BNFSEP \aReg\GETS\aLoc^{\amode}\SEMI \aCmd 
    %   \BNFSEP \aLoc^{\amode}\GETS\aExp\SEMI \aCmd
    %   \\[-.5ex]
    %   \BNFSEP&\aCmd \PAR[\aThrd][\bThrd] \bCmd
    %   \BNFSEP \VAR\aLoc\SEMI \aCmd
    %   \BNFSEP \IF{\aExp} \THEN \aCmd \ELSE \bCmd \FI
    % \end{aligned}
    % \\
    \begin{aligned}
      \sem[\aThrd]{\SKIP} & \eqdef
      \{ \DSTOP \}
      \\
      \sem[\aThrd]{\aReg\GETS\aExp\SEMI \aCmd} & \eqdef
      \sem[\aThrd]{\aCmd}[\aExp/\aReg]
      \\ 
      \sem{\aReg\GETS\aLoc^{\amode}\SEMI \aCmd} & \eqdef \textstyle\bigcup_\aVal\;
      (\DR[\amode]\aLoc\aVal)\prefix \sem{\aCmd} [\aLoc/\aReg]
      \\
      \sem{\aLoc^{\amode}\GETS\aExp\SEMI \aCmd} & \eqdef
      \textstyle\bigcup_\aVal\; (\aExp=\aVal \mid \DW[\amode]\aLoc\aVal)\prefix \sem{\aCmd}[\aExp/\aLoc]
      \\
      \sem{\FENCE^{\fmode}\SEMI \aCmd} & \eqdef
      (\DFS{\fmode}) \prefix \sem{\aCmd}
      \\
      \sem[\aThrd]{\IF{\aExp} \THEN \aCmd \ELSE \bCmd \FI} & \eqdef
      \bigl(\aExp \guard \sem[\aThrd]{\aCmd}\bigr) \parallel \bigl(\lnot\aExp \guard \sem[\aThrd]{\bCmd}\bigr) 
      \\
      \sem[\aThrd]{\aCmd \PAR[\bThrd][\bThrd'] \bCmd} & \eqdef
      \sem[\bThrd]{\aCmd} \parallel \sem[\bThrd']{\bCmd} 
      \\
      \sem[\aThrd]{\VAR\aLoc\SEMI \aCmd} & \eqdef
      \nu \aLoc \DOT \sem[\aThrd]{\aCmd}  
    \end{aligned}
  \end{gather*}
  \begin{align*}
    \amode \BNFDEF& \modeRLX &&\text{{(Relaxed)}} &\fmode \BNFDEF&\modeREL  &&\text{(Release)} &\hbox{$\;\mkern60mu\;$}&
    \\ \BNFSEP& \modeRA &&\text{{(Release/Acquire)}}            & \BNFSEP&\modeACQ   &&\text{(Acquire)} 
    \\ \BNFSEP& \modeSC &&\text{{(Sequentially Consistent)}}    &      \BNFSEP&\modeSC  &&\text{(SC)} 
  \end{align*}
  