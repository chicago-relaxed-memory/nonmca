\section{Model}

\begin{align*}
  \amode \BNFDEF& \mWK &&\text{{(Weak)}}                      &\ascope \BNFDEF& \sCTA &&\text{(Thread group)} &\hbox{$\;\mkern60mu\;$}&
  \\[-1ex] \BNFSEP& \mRLX &&\text{{(Relaxed)}}                & \BNFSEP&\sGPU   &&\text{(Processor)}                                   
  \\[-1ex] \BNFSEP& \mRA &&\text{{(Release/Acquire)}}         & \BNFSEP&\sSYS  &&\text{(System)}                                         
  \\[-1ex] \BNFSEP& \mSC &&\text{{(Sequentially Consistent)}}    
\end{align*}

Orders/Relations in model
\begin{itemize}
\item $\lestrong$ is the old $\le$ (without coherence stuff from \ref{rf4} and \ref{5b}).

  This provides the NO-TAR axiom.
\item $\lehb$ is a the \emph{happens-before} suborder, which only includes $\rrf$ when they are morally strong.

  This serves as a cross-location transitive kernel for the per-location order.
  
\item $\leloc$ is a per-location order that relates morally strong  and $\rpoloc$ accesses

  This includes $\lehb$ for  morally strong accesses.

  This provides the SC-PER-LOC axiom.

  % \item $\rrmw$ is a per-location relation on actions in an \RMW{}
\end{itemize}

Write $\bEv\conflict\aEv$ if they conflict (ie, read/write or write/write, same location).

Write $\bEv\moral\aEv$ if they conflict and are morally strong

\begin{definition}
  A \emph{pomset with preconditions} is a tuple
  $(\Event, \labeling, {\lehb}, {\lestrong}, {\leloc})$ where
  \begin{description}
  \item[{\labeltextsc[m1]{(m1)}{m1}}] $\Event$ is a set of \emph{events}
  \item[{\labeltextsc[m2]{(m2)}{m2}}]
    $\labeling: \Event \fun (\Formulae\times\Act)$ is a \emph{labeling} from
    which we derive functions
    \begin{itemize}
    \item $\labelingForm:\Event\fun\Formulae$
      \emph{(formulae)} % include $r{=}v$ $x{=}v$
    \item $\labelingAct:\Event\fun\Act$
      \emph{(actions)} %include $\DW{x}{v}$, $\DR{x}{v}$, and $\DSTOP$
    \end{itemize}
  \item[{\labeltextsc[m3]{(m3)}{m3}}]
    ${\lehb} \subseteq (\Event\times\Event)$,
    ${\lestrong} \subseteq (\Event\times\Event)$, and
    ${\leloc} \subseteq (\Event\times\Event)$ are partial orders
  \item[{\labeltextsc[m4]{(m4)}{m-consistency}}] $\bigwedge_{\aEv}\labelingForm(\aEv)$ is satisfiable \emph{(consistency)}
  \item[{\labeltextsc[m5]{(m5)}{m-causal-strengthening}}] if $\bEv\lestrong\aEv$ then $\labelingForm(\aEv)$ implies $\labelingForm(\bEv)$ \emph{(causal strengthening)} 
  \item[{\labeltextsc[m6]{(m6)}{m-strong}}] if $\bEv\lehb\aEv$ then $\bEv\lestrong\aEv$
  \item[{\labeltextsc[m7]{(m7)}{m-loc}}] if $\bEv\lehb\aEv$ and $\bEv$ conflicts with $\aEv$ then $\bEv\leloc\aEv$
  \end{description}
\end{definition}
% It is important that \ref{m-loc} covers all conflicting access.
% See \ref{pub1sys}.


  We say $\bEv\lthb\aEv$ when $\bEv\lehb\aEv$ and $\bEv\neq\aEv$, and similarly
  for $\ltstrong$ and $\ltloc$.

% \begin{definition}
%   Define $\leexists$ %and $\ltexists$
%   as follows:
% \end{definition}


\begin{definition}[Strong fulfillment]
  We say $\labelingAct(\bEv)=(\DW[]{x}{v})$ \emph{fulfills}
  $\labelingAct(\aEv)=(\DR[]{x}{v})$ if
  \begin{description}
  \item[{\labeltextsc[f3a]{(f3a)}{rf3a}}{\labeltextsc[f3]{}{rf3}}]
    $\bEv \ltstrong \aEv$
  \item[{\labeltextsc[f3b]{(f3b)}{rf3b}}]
    $\bEv \lthb \aEv$ if $\bEv$ is morally strong with $\aEv$
  \item[{\labeltextsc[f3c]{(f3c)}{rf3c}}]
    $\bEv \leloc \aEv$ (if $\bEv$ is not morally strong with $\aEv$)
  \item[{\labeltextsc[f4]{(f4)}{rf4}}]
    $\forall\labelingAct(\cEv)=(\DW[]{x}{..})$ either $\cEv \leloc \bEv$ or
    $\aEv \leloc \cEv$,
  \end{description}  
\end{definition}
  
\begin{definition}[Weak fulfillment]
  We say $\labelingAct(\bEv)=(\DW[]{x}{v})$ \emph{fulfills}
  $\labelingAct(\aEv)=(\DR[]{x}{v})$ if
  \begin{description}
  \item[{\labeltextsc[f3a]{(f3a)}{rf3a}}{\labeltextsc[f3]{}{rf3}}]
    $\bEv \ltstrong \aEv$
  \item[{\labeltextsc[f3b]{(f3b)}{rf3b}}]
    $\bEv \lthb \aEv$ if $\bEv$ is morally strong with $\aEv$
  \item[{\labeltextsc[f3c]{(f3c)}{rf3c}}]
    $\aEv \not\leloc \bEv$ (if $\bEv$ is not morally strong with $\aEv$)
  \item[{\labeltextsc[f4]{(f4)}{rf4}}]
    $\forall\labelingAct(\cEv)=(\DW[]{x}{..})$ either $\cEv \leexists \bEv$ or
    $\aEv \leexists \cEv$,
    where
  \begin{align*}
    \bEv\leexists\aEv &\textwhen                      
    \begin{cases}
      \bEv\leloc\aEv &\text{if}\; \bEv \;\text{is morally strong with}\;
      \aEv %\bEv\moral\aEv
      \\
      \aEv\not\ltloc\bEv &\text{otherwise}
    \end{cases}
    % \\
    % \bEv\ltexists\aEv &\textwhen                      
    % \begin{cases}
    %   \bEv\ltloc\aEv &\text{if}\; \bEv \;\text{is morally strong with}\;
    %   \aEv %\bEv\moral\aEv
    %   \\
    %   \aEv\not\leloc\bEv &\text{otherwise}
    % \end{cases}
  \end{align*}    
  \end{description}  
\end{definition}

If all accesses are morally strong with each other, weak fulfillment
degenerates to
\begin{description}
\item[\eqref{rf3}]
  $\bEv \lthb \aEv$
\item[\eqref{rf4}]
  $\forall\labelingAct(\cEv)=(\DW[]{x}{..})$ either
  $\cEv \leloc \bEv$ or $\aEv \leloc \cEv$
\end{description}

If no accesses are morally strong with each other, weak fulfillment
degenerates to
\begin{description}
\item[\eqref{rf3}]
  $\aEv \not\leloc \bEv$
\item[\eqref{rf4}]
  $\not\mkern-5mu\exists\labelingAct(\cEv)=(\DW[]{x}{..})$ 
  both $\bEv \ltloc \cEv$ and $\cEv \ltloc \aEv$
\end{description}
\begin{definition}
  Let $\aPS'\in(\aForm \mid \aAct) \prefix \aPSS$ when
  $(\exists\aPS\in\aPSS)$ $(\forall\aEv\in\Event)$
  \begin{description}
  \item[{\labeltextsc[P1]{(P1)}{1}}] $\Event' = \Event \cup \{\bEv\}$
  \item[{\labeltextsc[P2]{(P2)}{2}}] ${\le'}\supseteq{\lehb}$,
    ${\lestrong'}\supseteq{\lestrong}$, and ${\leloc'}\supseteq{\leloc}$
  \item[{\labeltextsc[P3]{(P3a)}{3a}\labeltextsc[P3]{}{3}}]%
    $\labelingAct'(\aEv) = \labelingAct(\aEv)$
  \item[{\labeltextsc[P3b]{(P3b)}{3b}}] $\labelingAct'(\bEv) = \aAct$
  \item[{\labeltextsc[P4a]{(P4a)}{4a}\labeltextsc[P4]{}{4}}]%
    $\labelingForm'(\bEv)$ implies
    $\aForm\land(\bEv\not\in\Event\lor\labelingForm(\bEv))$
  \item[{\labeltextsc[P4b]{(P4b)}{4b}}] if $\bEv\neq(\DR[]{..)}{}\mkern79mu$
    then $\aEv=\bEv$ or $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)$
  \item[{\labeltextsc[P4c]{(P4c)}{4c}}] if
    $\bEv=(\DR[]{\aVal}{\aLoc})\mkern70mu$ then $\aEv=\bEv$ or
    $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)[\aVal/\aLoc]$
  \item[{\labeltextsc[P5a]{(P5a)}{5a}\labeltextsc[P5]{}{5}}]%
    if $\bEv=(\DR[]{..)}{}$, $\aEv=(\DW[]{..)}{}$ then $\aEv=\bEv$ or
    $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)$ or $\bEv\le'\aEv$
  \item[{\labeltextsc[P5b]{(P5b)}{5b}}] if $\bEv$ conflicts with
    $\aEv$ %$\bEv\conflict\aEv$
    then $\bEv\leloc'\aEv$
  \item[{\labeltextsc[P5c]{(P5c)}{5c}}] if $\bEv$ is an acquire or $\aEv$ is
    a release then $\bEv \le' \aEv$
  \item[{\labeltextsc[P5d]{(P5d)}{5d}}] if $\bEv$ is an SC write and $\aEv$
    is an SC read then $\bEv \le' \aEv$
  \item[{\labeltextsc[P5e]{(P5e)}{5e}}] if $\bEv$ reads, and $\aEv$ is an
    acquiring fence, then
    $\bEv \le' \aEv$
  \item[{\labeltextsc[P5f]{(P5f)}{5f}}] if $\bEv$ is a releasing fence,
    and $\aEv$ writes, then
    $\bEv \le' \aEv$
  \end{description}
\end{definition}

\section{IMM Examples}

Interpreting this definition for the \IMM:
\begin{itemize}
\item No $\mWK$, default is $\mRLX$
\item All threads in same $\sCTA$ (only one scope)
\item Actions are morally strong when both are $\mRA$/$\mSC$, mimicking happens-before
\item Strong fulfillment may do the right thing 
\end{itemize}

Disallowed by \IMM{}:
\begin{gather*}
  \PW{x}{2}\SEMI 
  \PW[\mRA]{y}{1} \PAR
  \PR[\mRA]{y}{r}\SEMI
  \PW{x}{1}
  \\
  \tag{\xmark\IMM}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DW[\mRA]{y}{1}}{right=of a}
      \event{c}{\DR[\mRA]{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      \bob{a}{b}
      \rfe{b}{c}
      \bob{c}{d}
      \coe[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
  \\
  \tag{${\lestrong}={\lehb}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DW[\mRA]{y}{1}}{right=of a}
      \event{c}{\DR[\mRA]{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      \sync{a}{b}
      \rf{b}{c}
      \sync{c}{d}
      %\wk[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
  \\
  \tag{$\lelocstrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DW[\mRA]{y}{1}}{right=of a}
      \event{c}{\DR[\mRA]{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      %\sync{a}{b}
      \rf{b}{c}
      %\sync{c}{d}
      \po[out=15,in=165]{a}{d}
      %\wk[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
\end{gather*}

Allowed by \IMM, but not by Power/ARMv7/ARMv8/TSO:
\begin{gather*}
  \PW{x}{2}\SEMI 
  \PW[\mRA]{y}{1} \PAR
  \PR{y}{r}\SEMI
  \PW{x}{r}
  \\
  \tag{\cmark\IMM}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DW[\mRA]{y}{1}}{right=of a}
      \event{c}{\DR{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      \bob{a}{b}
      \rfe{b}{c}
      \data{c}{d}
      \coe[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
  \\
  \tag{$\lestrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DW[\mRA]{y}{1}}{right=of a}
      \event{c}{\DR{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      \sync{a}{b}
      \rf{b}{c}
      \po{c}{d}
      %\wk[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
  \\
  \tag{$\lehb$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DW[\mRA]{y}{1}}{right=of a}
      \event{c}{\DR{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      \sync{a}{b}
      %\rfe{b}{c}
      \po{c}{d}
      %\wk[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
  \\
  \tag{$\lelocstrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DW[\mRA]{y}{1}}{right=of a}
      \event{c}{\DR{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      %\sync{a}{b}
      \rf{b}{c}
      %\po{c}{d}
      %\wk[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
\end{gather*}
Anton says we could potentially disallow by adding an axiom to \IMM{}
forbidding cycles in
$\rco \cup ([W]; \rrfe^?; ([R^{\mRA}] \cup \rpox; [FW^{\mRA}]); \rar^{*};
[W])$


Need $\lestrong$ to prevent thin air on $\mRLX$:
\begin{gather*}
  \PW{y}{\PR{x}{}}\PAR
  \PW{x}{\PR{y}{}}
  \\
  \tag{$\lestrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{\DW{y}{1}}{right=of a}
      \event{c}{\DR{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      \po{a}{b}
      \rf{b}{c}
      \po{c}{d}
      \rf[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
  \\
  \tag{$\lehb$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{\DW{y}{1}}{right=of a}
      \event{c}{\DR{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      \po{a}{b}
      \po{c}{d}
    \end{tikzinline}}
  \\
  \tag{$\lelocstrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{\DW{y}{1}}{right=of a}
      \event{c}{\DR{y}{1}}{right=2.5em of b}
      \event{d}{\DW{x}{1}}{right=of c}
      \rf{b}{c}
      \rf[out=-165,in=-15]{d}{a}
    \end{tikzinline}}
\end{gather*}
Example from talk:
\begin{gather*}
  r\GETS x\SEMI x\GETS 1
  \PAR
  y\GETS x 
  \PAR
  x\GETS y 
  \\[-1.2ex]
  \tag{$\lestrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{d:\DW{x}{1}}{right=of a}
      %\wk{a}{b}
      \event{c}{\DR{x}{1}}{right=3em of b}
      \event{d}{\DW{y}{1}}{right=of c}
      \po{c}{d}
      \event{e}{\DR{y}{1}}{right=3em of d}
      \event{f}{e:\DW{x}{1}}{right=of e}
      \po{e}{f}
      \rf{b}{c}
      \rf{d}{e}
      \rf[out=172,in=8]{f}{a}
    \end{tikzinline}}
  \\
  \tag{$\lehb$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{d:\DW{x}{1}}{right=of a}
      %\wk{a}{b}
      \event{c}{\DR{x}{1}}{right=3em of b}
      \event{d}{\DW{y}{1}}{right=of c}
      \po{c}{d}
      \event{e}{\DR{y}{1}}{right=3em of d}
      \event{f}{e:\DW{x}{1}}{right=of e}
      \po{e}{f}
      %\rf{b}{c}
      %\rf{d}{e}
      %\rf[out=172,in=8]{f}{a}
    \end{tikzinline}}
  \\
  \tag{$\lelocstrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{d:\DW{x}{1}}{right=of a}
      \wk{a}{b}
      \event{c}{\DR{x}{1}}{right=3em of b}
      \event{d}{\DW{y}{1}}{right=of c}
      %\po{c}{d}
      \event{e}{\DR{y}{1}}{right=3em of d}
      \event{f}{e:\DW{x}{1}}{right=of e}
      % \po{e}{f}
      %\po[out=-15,in=-165]{c}{f}
      \rf{b}{c}
      \rf{d}{e}
      \rf[out=172,in=8]{f}{a}
    \end{tikzinline}}
  \\
  \tag{$\lelocweak$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{d:\DW{x}{1}}{right=of a}
      \wk{a}{b}
      \event{c}{\DR{x}{1}}{right=3em of b}
      \event{d}{\DW{y}{1}}{right=of c}
      %\po{c}{d}
      \event{e}{\DR{y}{1}}{right=3em of d}
      \event{f}{e:\DW{x}{1}}{right=of e}
      % \po{e}{f}
      %\po[out=-15,in=-165]{c}{f}
      %\rf{b}{c}
      %\rf{d}{e}
      %\rf[out=172,in=8]{f}{a}
    \end{tikzinline}}
\end{gather*}
Comment: Two order idea from OOPLSA talk does not work for this example.  In
this setting it corresponds to:
\begin{itemize}
\item Require: $\bEv\leloc\aEv$ when $\bEv\lestrong\aEv$ and they conflict
\end{itemize}
Using this, we would have a cycle (weak/strong fulfillment not relevant here):
\begin{gather*}
  \tag{$\leloc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{d:\DW{x}{1}}{right=of a}
      \wk{a}{b}
      \event{c}{\DR{x}{1}}{right=3em of b}
      \event{d}{\DW{y}{1}}{right=of c}
      %\po{c}{d}
      \event{e}{\DR{y}{1}}{right=3em of d}
      \event{f}{e:\DW{x}{1}}{right=of e}
      % \po{e}{f}
      \po[out=-15,in=-165]{c}{f}
      \rf{b}{c}
      \rf{d}{e}
      \rf[out=172,in=8]{f}{a}
    \end{tikzinline}}    
\end{gather*}



\section{PTX Examples}
Based on \cite{DBLP:conf/asplos/LustigSG19,nvidia}.

\PTX{} requires weak fulfillment.

Default scope is $\sCTA$.  In examples, all threads in different $\sCTA$s.

Default mode is $\mWK$.


$(\DR{x}{0})$ must be forbidden.
Before fulfilling the read:
\begin{gather*}
  \taglabel[sys]{pub1}
  \PW{x}{0}\SEMI 
  \PW{x}{1}\SEMI
  \PW[\mRA]{y}[\sSYS]{1} \PAR
  \PR[\mRA]{y}[\sSYS]{r}\SEMI
  \PR{x}{s}
  \\
  \tag{${\lestrong}={\lehb}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA]{y}[\sSYS]{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA]{y}[\sSYS]{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      \sync[out=-15,in=-165]{wx0}{wy1}
      \sync{wx1}{wy1}
      \sync{ry1}{rx}
      \rf{wy1}{ry1}
    \end{tikzinline}}
  \\
  \tag{$\leloc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA]{y}[\sSYS]{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA]{y}[\sSYS]{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      \rf{wy1}{ry1}
      \wk{wx0}{wx1}
      \po[out=-15,in=-165]{wx1}{rx}
    \end{tikzinline}}
\end{gather*}
$(\DW{x}{1})\leexists(\DR{x}{})$ is required by \ref{m-loc}, enforcing publication.

$(\DR{x}{0})$ must be allowed:
\begin{gather*}
  \taglabel[cta]{pub1}
  \PW{x}{0}\SEMI 
  \PW{x}{1}\SEMI
  \PW[\mRA]{y}{1} \PAR
  \PR[\mRA]{y}{r}\SEMI
  \PR{x}{s}
  \\
  \tag{${\lestrong}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA]{y}{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA]{y}{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      \sync[out=-15,in=-165]{wx0}{wy1}
      \sync{wx1}{wy1}
      \sync{ry1}{rx}
      \rf{wy1}{ry1}
    \end{tikzinline}}
  \\
  \tag{${\lehb}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA]{y}{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA]{y}{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      \sync[out=-15,in=-165]{wx0}{wy1}
      \sync{wx1}{wy1}
      \sync{ry1}{rx}
      % \rf{wy1}{ry1}
    \end{tikzinline}}
  \\
  \tag{$\leloc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wx1}{\DW{x}{1}}{right=of wx0}
      \event{wy1}{\DW[\mRA]{y}{1}}{right=of wx1}
      \event{ry1}{\DR[\mRA]{y}{1}}{right=2.5em of wy1}
      \event{rx}{\DR{x}{}}{right=of ry1}
      % \rf{wy1}{ry1}
      \wk{wx0}{wx1}
      % \wk[out=-15,in=-165]{wx1}{rx}
    \end{tikzinline}}
\end{gather*}
We do not have $(\DW[\mRA]{y}{1})\lehb (\DR[\mRA]{y}{1})$ since \ref{rf3} only
requires order for things that are morally strong.  

Another example that may be of interest (nothing morally strong).  Can this $(\DR{x}{0})$?
\begin{gather*}
  %\taglabel[cta]{pub1}
  \PW{x}{0} \SEMI
  \PW{x}{1} \PAR 
  \PW{y}{\PR{x}{}} \PAR
  \IF{\PR{y}{}}\THEN \PR{x}{r} \FI
\end{gather*}

\PTX{} allows TC16 for events that are not mutually strong (\ref{tc16wk}),
but disallows it when events are mutually strong (\ref{tc16sys}).  Note that
$\lehb$ imposes no requirements here.  Fulfillment imposes no order.  This
example shows that \ref{rf3c} cannot be strengthened to require that
$\bEv\leloc\aEv$.
\begin{gather*}
  \taglabel[wk]{tc16}
  \PR{x}{r} \SEMI \PW{x}{1}
  \PAR
  \PR{x}{s} \SEMI \PW{x}{2}
  \\
  \tag{$\lestrong$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR{x}{2}}{}
      \event{a2}{\DW{x}{1}}{right=of a1}
      \event{b1}{\DR{x}{1}}{right=3em of a2}
      \event{b2}{\DW{x}{2}}{right=of b1}
      \rf{a2}{b1}
      \rf[out=-165,in=-15]{b2}{a1}
    \end{tikzinline}}
  \\
  \tag{$\lehb$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR{x}{2}}{}
      \event{a2}{\DW{x}{1}}{right=of a1}
      \event{b1}{\DR{x}{1}}{right=3em of a2}
      \event{b2}{\DW{x}{2}}{right=of b1}
    \end{tikzinline}}
  \\
  \tag{$\leloc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR{x}{2}}{}
      \event{a2}{\DW{x}{1}}{right=of a1}
      \event{b1}{\DR{x}{1}}{right=3em of a2}
      \event{b2}{\DW{x}{2}}{right=of b1}
      \wk{a1}{a2}
      \wk{b1}{b2}
      % \rf{a2}{b1}
      % \rf[out=-165,in=-15]{b2}{a1}
    \end{tikzinline}}
\end{gather*}
\begin{gather*}
  \taglabel[sys]{tc16}
  \PR[\mRLX]{x}[\sSYS]{r} \SEMI \PW[\mRLX]{x}[\sSYS]{1}
  \PAR                                              
  \PR[\mRLX]{x}[\sSYS]{s} \SEMI \PW[\mRLX]{x}[\sSYS]{2}
  \\
  \tag{${\lestrong}={\lehb}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR[\mRLX]{x}[\sSYS]{2}}{}
      \event{a2}{\DW[\mRLX]{x}[\sSYS]{1}}{right=of a1}
      \event{b1}{\DR[\mRLX]{x}[\sSYS]{1}}{right=3em of a2}
      \event{b2}{\DW[\mRLX]{x}[\sSYS]{2}}{right=of b1}
      \rf{a2}{b1}
      \rf[out=-165,in=-15]{b2}{a1}
    \end{tikzinline}}
  \\
  \tag{$\leloc$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR[\mRLX]{x}[\sSYS]{2}}{}
      \event{a2}{\DW[\mRLX]{x}[\sSYS]{1}}{right=of a1}
      \event{b1}{\DR[\mRLX]{x}[\sSYS]{1}}{right=3em of a2}
      \event{b2}{\DW[\mRLX]{x}[\sSYS]{2}}{right=of b1}
      \wk{a1}{a2}
      \wk{b1}{b2}
      \rf{a2}{b1}
      \rf[out=-165,in=-15]{b2}{a1}
    \end{tikzinline}}
\end{gather*}

About Release-Acquire semantics.  Anton confirms that the following example
is allowed in C11, but disallowed in the \IMM{}.  It is apparently allowed in
C11 with the intention to allow releasing writes to be downgraded to relaxed
in the case that only fulfill relaxed reads.
\begin{gather*}
  \taglabel{LB-REL}
  \PR[\mRLX]{x}[\sSYS]{r} \SEMI \PW[\mRA]{y}[\sSYS]{1}
  \PAR                                             
  \PR[\mRLX]{y}[\sSYS]{s} \SEMI \PW[\mRA]{x}[\sSYS]{1}
  \\
  \tag{${\lestrong}={\lehb}$}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DR[\mRLX]{x}[\sSYS]{1}}{}
      \event{a2}{\DW[\mRA]{y}[\sSYS]{1}}{right=of a1}
      \event{b1}{\DR[\mRLX]{y}[\sSYS]{1}}{right=3em of a2}
      \event{b2}{\DW[\mRA]{x}[\sSYS]{1}}{right=of b1}
      \rf{a2}{b1}
      \rf[out=-165,in=-15]{b2}{a1}
      \sync{a1}{a2}
      \sync{b1}{b2}
    \end{tikzinline}}
\end{gather*}


\section{RFI Examples}

Anton example 1 (Allowed by ARM) \texttt{[rfi-bob-coe-coe]}
\begin{gather*}
  \taglabel{rfi-bob-coe-coe}
  \PW{x}{2}\SEMI 
  \PR[\mRA]{x}{r}\SEMI
  \PW{y}{1} \PAR
  \PW{y}{2}\SEMI
  \PW[\mRA]{x}{1}
  \\
  \tag{\cmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DR[\mRA]{x}{2}}{right=of a}
      \event{c}{\DW{y}{1}}{right=of b}
      \event{d}{\DW{y}{2}}{right=2.5em of c}
      \event{e}{\DW[\mRA]{x}{1}}{right=of d}
      \rfi{a}{b}
      \bob{b}{c}
      \coe{c}{d}
      \bob{d}{e}
      \coe[out=-165,in=-15]{e}{a}
    \end{tikzinline}}
\end{gather*}

To allow this, weaken $\mRA$ to $\mRLX$ when read fulfilled by relaxed write
of same thread (don't need to allow this when the write is part of an \RMW{}).
\begin{gather*}
  \PW{x}{2}\SEMI 
  \PR[\mRA]{x}{r}\SEMI
  \PW{y}{1} \PAR
  \PW{y}{2}\SEMI
  \PW[\mRA]{x}{1}
  \\
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DR{x}{2}}{right=of a}
      \event{c}{\DW{y}{1}}{right=of b}
      \event{d}{\DW{y}{2}}{right=2.5em of c}
      \event{e}{\DW[\mRA]{x}{1}}{right=of d}
      \rf{a}{b}
      %\sync{b}{c}
      \wk{c}{d}
      \sync{d}{e}
      \wk[out=-165,in=-15]{e}{a}
    \end{tikzinline}}
\end{gather*}

RF variant \texttt{[rfi-bob-rfe-coe]}:
\begin{gather*}
  \taglabel{rfi-bob-rfe-coe}
  \PW{x}{2}\SEMI 
  \PR[\mRA]{x}{r}\SEMI
  \PW{y}{1} \PAR
  \PR{y}{s}\SEMI
  \PW[\mRA]{x}{1}
  \\
  \tag{\cmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DR[\mRA]{x}{2}}{right=of a}
      \event{c}{\DW{y}{1}}{right=of b}
      \event{d}{\DR{y}{1}}{right=2.5em of c}
      \event{e}{\DW[\mRA]{x}{1}}{right=of d}
      \rfi{a}{b}
      \bob{b}{c}
      \rfe{c}{d}
      \bob{d}{e}
      \coe[out=-165,in=-15]{e}{a}
    \end{tikzinline}}
\end{gather*}

TSO variant \texttt{[rfi-bob-fre-coe]}:
\begin{gather*}
  \taglabel{rfi-bob-coe-coe}
  \PW{x}{2}\SEMI 
  \PR[\mRA]{x}{r}\SEMI
  \PR{y}{s} \PAR
  \PW{y}{2}\SEMI
  \PW[\mRA]{x}{1}
  \\
  \tag{\cmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DR[\mRA]{x}{2}}{right=of a}
      \event{c}{\DR{y}{0}}{right=of b}
      \event{d}{\DW{y}{2}}{right=2.5em of c}
      \event{e}{\DW[\mRA]{x}{1}}{right=of d}
      \rfi{a}{b}
      \bob{b}{c}
      \fre{c}{d}
      \bob{d}{e}
      \coe[out=-165,in=-15]{e}{a}
    \end{tikzinline}}
\end{gather*}

Double FRE variant \texttt{[rfi-bob-fre-fre]}:
\begin{gather*}
  \taglabel{rfi-bob-fre-fre}
  \PW{x}{2}\SEMI 
  \PR[\mRA]{x}{r}\SEMI
  \PR{y}{s} \PAR
  \PW{y}{2}\SEMI
  \PF{}\SEMI
  \PR{x}{r}
  \\
  \tag{\cmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DR[\mRA]{x}{2}}{right=of a}
      \event{c}{\DR{y}{0}}{right=of b}
      \event{d}{\DW{y}{2}}{right=2.5em of c}
      \event{e}{\DF{}}{right=of d}
      \event{f}{\DR{x}{0}}{right=of e}
      \rfi{a}{b}
      \bob{b}{c}
      \fre{c}{d}
      \bob{d}{e}
      \bob{e}{f}
      \fre[out=-165,in=-15]{f}{a}
    \end{tikzinline}}
\end{gather*}

It does not seem possible to do this only with $\rrfe$.
ARM disallows this \texttt{[data-rfi-rfe-rfe]}:
\begin{gather*}
  \taglabel{data-rfi-rfe-rfe}
  \PW{x}{\PR{z}{}} \SEMI
  \PR[\mRA]{x}{r}\SEMI
  \PW{y}{1} \PAR
  \PW{z}{\PR{y}{}}
  \\
  \tag{\xmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{z}{1}}{}
      \event{b}{\DW{x}{1}}{right=of a}
      \event{c}{\DR[\mRA]{x}{1}}{right=of b}
      \event{d}{\DW{y}{1}}{right=of c}
      \event{e}{\DW{y}{1}}{right=2.5em of d}
      \event{f}{\DW{z}{1}}{right=of e}
      \data{a}{b}
      \rfi{b}{c}
      \bob{c}{d}
      \data{e}{f}
      \rfe[out=-165,in=-15]{f}{a}
      \rfe{d}{e}
    \end{tikzinline}}
\end{gather*}

It also disallows \texttt{[ctrl-rfi-rfe-rfe]}:
\begin{gather*}
  \taglabel{ctrl-rfi-rfe-rfe}
  \IF{\PR{z}{}}\THEN\FI \SEMI
  \PW{x}{1} \SEMI
  \PR[\mRA]{x}{r}\SEMI
  \PW{y}{1}
  \PAR
  \PW{z}{\PR{y}{}}
  \\
  \tag{\xmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{z}{1}}{}
      \event{b}{\DW{x}{1}}{right=of a}
      \event{c}{\DR[\mRA]{x}{1}}{right=of b}
      \event{d}{\DW{y}{1}}{right=of c}
      \event{e}{\DW{y}{1}}{right=2.5em of d}
      \event{f}{\DW{z}{1}}{right=of e}
      \ctrl[out=15,in=165]{a}{d}
      \rfi{b}{c}
      \bob{c}[below]{d}
      \data{e}{f}
      \rfe[out=-165,in=-15]{f}{a}
      \rfe{d}{e}
    \end{tikzinline}}
\end{gather*}

ARM allows some counterintuitive results for SC access \texttt{[ctrl-rfi-fre-rfe]}:
\begin{gather*}
  \taglabel{ctrl-rfi-fre-rfe}
  \IF{\PR{x}{}}\THEN\FI\SEMI
  \PW{x}{2} \SEMI
  \PR[\mSC]{x}{r}\SEMI
  \PR[\mSC]{y}{s} \PAR
  \PW[\mSC]{y}{2}\SEMI
  \PW[\mSC]{x}{1}
  \\
  \tag{\cmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{\DW{x}{2}}{right=of a}
      \event{c}{\DR[\mSC]{x}{2}}{right=of b}
      \event{d}{\DR[\mSC]{y}{0}}{right=of c}
      \event{e}{\DW[\mSC]{y}{2}}{right=2.5em of d}
      \event{f}{\DW[\mSC]{x}{1}}{right=of e}
      \ctrl{a}{b}
      \rfi{b}{c}
      \bob{c}{d}
      \bob{e}{f}
      \fre{d}{e}
      \rfe[out=-165,in=-15]{f}{a}
    \end{tikzinline}}
\end{gather*}
Not possible with $\rcoe$ \texttt{[ctrl-rfi-coe-rfe]}:
\begin{gather*}
  \taglabel{ctrl-rfi-coe-rfe}
  \IF{\PR{x}{}}\THEN\FI\SEMI
  \PW{x}{2} \SEMI
  \PR[\mSC]{x}{r}\SEMI
  \PW[\mSC]{y}{1} \PAR
  \PW[\mSC]{y}{2}\SEMI
  \PW[\mSC]{x}{1}
  \\
  \tag{\xmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{\DW{x}{2}}{right=of a}
      \event{c}{\DR[\mSC]{x}{2}}{right=of b}
      \event{d}{\DW[\mSC]{y}{1}}{right=of c}
      \event{e}{\DW[\mSC]{y}{2}}{right=2.5em of d}
      \event{f}{\DW[\mSC]{x}{1}}{right=of e}
      \ctrl[out=15,in=165]{a}{d}
      \rfi{b}{c}
      \bob{c}{d}
      \bob{e}{f}
      \coe{d}{e}
      \rfe[out=-165,in=-15]{f}{a}
    \end{tikzinline}}
\end{gather*}

This is not allowed with a data dependency instead of a control dependency \texttt{[data-rfi-fre-rfe]}:
\begin{gather*}
  \taglabel{data-rfi-fre-rfe}
  \PW{x}{\PR{x}{}{+}1} \SEMI
  \PR[\mSC]{x}{r}\SEMI
  \PR[\mSC]{y}{s} \PAR
  \PW[\mSC]{y}{1}\SEMI
  \PW[\mSC]{x}{1}
  \\
  \tag{\xmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{1}}{}
      \event{b}{\DW{x}{2}}{right=of a}
      \event{c}{\DR[\mSC]{x}{2}}{right=of b}
      \event{d}{\DR[\mSC]{y}{0}}{right=of c}
      \event{e}{\DW[\mSC]{y}{1}}{right=2.5em of d}
      \event{f}{\DW[\mSC]{x}{1}}{right=of e}
      \data{a}{b}
      \rfi{b}{c}
      \bob{c}{d}
      \bob{e}{f}
      \fre{d}{e}
      \rfe[out=-165,in=-15]{f}{a}
    \end{tikzinline}}
\end{gather*}

\section{SC Examples}

\ref{IRIW-aqc-sc} is allowed by trailing-sync compilation to power
\cite[\textsection 1]{DBLP:conf/pldi/LahavVKHD17}.
\begin{gather*}
  \PW[\mSC]{x}{1}
  \PAR
  \PW[\mSC]{y}{1}
  \PAR
  \PR[\mRA]{x}{r}\SEMI \PR[\mSC]{y}{s}
  \PAR
  \PR[\mRA]{y}{r}\SEMI \PR[\mSC]{x}{s}
  \taglabel{IRIW-aqc-sc}
  \\
  \tag{\cmark\ppc,\rcXI}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      % \event{wx0}{\DW{x}{0}}{}
      % \event{wx1}{\DW{x}{1}}{right=of wx0}
      % \event{wy0}{\DW{y}{0}}{below=4ex of wx0}
      % \event{wy1}{\DW{y}{1}}{right=of wy0}
      \event{wx1}{\DW[\mSC]{x}{1}}{}
      \event{wy1}{\DW[\mSC]{y}{1}}{below=4ex of wx1}
      \event{ry1}{\DR[\mRA]{y}{1}}{right=2.5em of wy1}
      \event{rx0}{\DR[\mSC]{x}{0}}{right=of ry1}
      \event{rx1}{\DR[\mRA]{x}{1}}{right=2.5 em of wx1}
      \event{ry0}{\DR[\mSC]{y}{0}}{right=of rx1}
      % \wk{wx0}{wx1}
      % \wk{wy0}{wy1}
      % \rf[bend left]{wy0}{ry0}
      % \rf[bend right]{wx0}{rx0}
      \sync{rx1}{ry0}
      \sync{ry1}{rx0}
      \rf{wx1}{rx1}
      \rf{wy1}{ry1}
      \wk{rx0}{wx1}
      \wk{ry0}{wy1}
    \end{tikzinline}}
\end{gather*}
Leading sync is also unsound in \cXI{} with \RMW{}
\cite[\textsection 2.1]{DBLP:conf/pldi/LahavVKHD17}.
\begin{gather*}
  \PW[\mSC]{x}{1} \SEMI \PW[\mRA]{y}{1}
  \PAR
  \FADD^{\mSC,\mSC}(y,1) \SEMI \PR{y}{s}
  \PAR
  \PW[\mSC]{y}{3} \SEMI \PR[\mSC]{x}{s}
  \taglabel{Z6.U}
  \\
  \tag{\cmark\ppc,\rcXI}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW[\mSC]{x}{1}}{}
      \event{b}{\DW[\mRA]{y}{1}}{right=of a}
      \event{c1}{\DR[\mSC]{y}{1}}{right=2.5em of b}
      \event{c2}{\DW[\mSC]{y}{2}}{right=of c1}
      \event{d}{\DR{y}{3}}{right=of c2}
      \event{e}{\DW[\mSC]{y}{3}}{right=2.5 em of d}
      \event{f}{\DR[\mSC]{x}{0}}{right=of e}
      \sync{a}{b}
      \rf{b}{c1}
      \rf{e}{d}
      \rmw{c1}{c2}
      %\wk{c2}{d}
      \wk[out=-15,in=-165]{c2}{e}
      % \sync[out=-15,in=-165]{c1}{d}
      %\wk{c2}{d}
      \sync{e}{f}
      \wk[out=-165,in=-15]{f}{a}
    \end{tikzinline}}
\end{gather*}
Leading sync is also unsound in \cXI{} with SC fences
\cite[\textsection A.1]{DBLP:conf/pldi/LahavVKHD17}.
\begin{gather*}
  \PW{x}{2} \SEMI \PF{\mSC} \SEMI \PR{y}{r}
  \PAR
  \PW[\mSC]{y}{1}
  \PAR
  \PR[\mRA]{y}{r} \SEMI \PW[\mRA]{x}{1}  \SEMI \PR{x}{s}
  \PAR
  \PR[\mSC]{x}{r}
   \taglabel{rsync+rsc}
  \\
  \tag{\cmark\rcXI}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{x}{2}}{}
      \event{b}{\DF{\mSC}}{right=of a}
      \event{c}{\DR{y}{0}}{right=of b}
      \event{d}{\DW[\mSC]{y}{1}}{right=2.5em of c}
      \event{e}{\DR[\mRA]{y}{1}}{right=2.5em of d}
      \event{f}{\DW[\mRA]{x}{1}}{right=of e}
      \event{g}{\DR{x}{2}}{right=of f}
      \event{h}{\DR[\mSC]{x}{1}}{right=2.5em of g}
      \sync{a}{b}
      \sync{b}{c}
      \rf{d}{e}
      \rf[out=-15,in=-165]{f}{h}
      \wk[in=-15,out=-165]{f}{a}
      %\rf[out=-15,in=-165]{a}{g}
      \wk{c}{d}
      \wk{f}{g}
      \sync{e}{f}
      %\sync[out=15,in=165]{e}{g}
    \end{tikzinline}}
\end{gather*}
Fulfillment of $(\DR{x}{2})$ requires that either
\begin{math}
  (\DW[\mRA]{x}{1})
  \xwk
  (\DW{x}{2})
\end{math}
or 
\begin{math}
  (\DR{x}{2})
  \xwk
  (\DW[\mRA]{x}{1}).
\end{math}
It's interesting that in the pomset, $(\DR[\mSC]{x}{1})$ is not needed to get
a cycle.

There is a long discussion of this in \cite[\textsection 5.2,
Fig.~17]{DBLP:journals/pacmpl/BenderP19}, where they also discuss this example:
\begin{gather*}
  \PW[\mSC]{x}{1}\SEMI \PW{x}{2}
  \PAR
  \PW[\mSC]{y}{1}\SEMI \PW{y}{2}
  \PAR
  \PR[\mRA]{x}{r}\SEMI \PR[\mSC]{y}{s}
  \PAR
  \PR[\mRA]{y}{r}\SEMI \PR[\mSC]{x}{s}
  \taglabel{IRIW-sc-rlx-acq}
  \\
  \tag{\cmark\rcXI}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{wx1}{\DW[\mSC]{x}{1}}{}
      \event{wx2}{\DW{x}{2}}{right=of wx1}
      \event{wy1}{\DW[\mSC]{y}{1}}{below=4ex of wx1}
      \event{wy2}{\DW{y}{2}}{right=of wy1}
      \event{ry1}{\DR[\mRA]{y}{2}}{right=2.5em of wy2}
      \event{rx0}{\DR[\mSC]{x}{0}}{right=of ry1}
      \event{rx1}{\DR[\mRA]{x}{2}}{right=2.5 em of wx2}
      \event{ry0}{\DR[\mSC]{y}{0}}{right=of rx1}
      \sync{rx1}{ry0}
      \sync{ry1}{rx0}
      \rf{wx2}{rx1}
      \rf{wy2}{ry1}
      \wk{rx0}{wx1}
      \wk{ry0}{wy1}
      \wk{wx1}{wx2}
      \wk{wy1}{wy2}
    \end{tikzinline}}
\end{gather*}


\cite[\textsection A.2]{DBLP:conf/pldi/LahavVKHD17} claims that \armeight{}
allows this \texttt{[RWC+acq+sc]}, but \href{http://diy.inria.fr/www/?record=aarch64}{herd7} rejects it.
%\verbatiminput{litmus/RWC+acq+sc.litmus}
% More legibly:
% \begin{verbatim}
% STLR#1,[x]     | LDR a, [x] /1    | STLR #1, [y] 
%                | DMB LD           | LDAR c, [x] /0
%                | LDAR b, [y] /0
% \end{verbatim}
Reason: they are citing the flowing/pop model
\cite{DBLP:conf/popl/FlurGPSSMDS16} rather than
\cite{DBLP:journals/pacmpl/PulteFDFSS18}.
\begin{gather*}
  \taglabel{rwc+acq+sc}
  \PW[\mSC]{x}{1} \PAR
  \PR{x}{r}\SEMI
  \PF{\mACQ}\SEMI
  \PR[\mSC]{y}{s} \PAR
  \PW[\mSC]{y}{1}\SEMI
  \PR[\mSC]{x}{r}
  \\
  \tag{\xmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW[\mSC]{x}{1}}{}
      \event{b}{\DR{x}{1}}{right=2.5em of a}
      \event{c}{\DF{\mACQ}}{right=of b}
      \event{d}{\DR[\mSC]{y}{0}}{right=of c}
      \event{e}{\DW[\mSC]{y}{1}}{right=2.5em of d}
      \event{f}{\DR[\mSC]{x}{0}}{right=of e}
      \rfe{a}{b}
      \sync{b}{c}
      \sync{c}{d}
      \fre[out=-165,in=-15]{f}{a}
      \fre{d}{e}
      \sync{e}{f}
    \end{tikzinline}}
\end{gather*}

\section{RMWs}
From \cite[\textsection 3.3]{DBLP:journals/pacmpl/BenderP19}.  With partial
coherence/weak fulfillment you need to be careful that \RMW{}s are totally
ordered (if that's a property you want).  May not come for free.



\section{Example from JAM paper}
From \cite[\textsection B]{DBLP:journals/pacmpl/BenderP19}:
``Here we demonstrate that it is possible to construct a program that is only
forbidden due to the total coherence order''

\begin{comment}
AArch64 TotalCO
{
0:X1=x; 0:X3=y; 
1:X1=x; 1:X3=y;
2:X1=x; 2:X3=y;
}
 P0            | P1           | P2;
 LDR X2,[X1]   | LDAR X5, [X3]| LDAR X5,[X1];
 MOV X0,#1     | MOV X2,#2    | MOV X0, #1;
 STR X0,[X1]   | STR X2,[X1]  | STR X0, [X3];

exists (0:X2=2 /\ 1:X5=1 /\ 2:X5=1)
\end{comment}


\begin{gather*}
  \PR{x}{r}\SEMI
  \PW{x}{1}
  \PAR
  \PR[\mRA]{x}{r}\SEMI
  \PW{x}{1}
  \PAR
  \PR[\mRA]{y}{r}\SEMI
  \PW{x}{2}
  \taglabel{Total-CO}
  \\
  \tag{\xmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{2}}{}
      \event{b}{\DW{x}{1}}{right=of a}
      \event{c}{\DR[\mACQ]{x}{1}}{right=2.5em of b}
      \event{d}{\DW{y}{1}}{right=of c}
      \event{e}{\DR[\mACQ]{y}{1}}{right=2.5em of d}
      \event{f}{\DW{x}{2}}{right=of e}
      \wk{a}{b}
      \sync{c}{d}
      \sync{e}{f}
      \rf{b}{c}
      \rf{d}{e}
      \rf[out=-165,in=-15]{f}{a}
    \end{tikzinline}}
  % \\
  % \tag{\xmark\armeight}
  % \hbox{\begin{tikzinline}[node distance=1.5em]
  %     \event{a}{\DR{x}{2}}{}
  %     \event{b}{\DW{x}{1}}{right=of a}
  %     \event{c}{\DR[\mACQ]{x}{1}}{right=2.5em of b}
  %     \event{d}{\DW{y}{1}}{right=of c}
  %     \event{e}{\DR[\mACQ]{y}{1}}{right=2.5em of d}
  %     \event{f}{\DW{x}{2}}{right=of e}
  %     \poloc{a}{b}
  %     \co[out=15,in=165]{b}{f}
  %     \rfx[out=-165,in=-15]{f}{a}
  %   \end{tikzinline}}
  \\
  \tag{\xmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{2}}{}
      \event{b}{\DW{x}{1}}{right=of a}
      \event{c}{\DR[\mACQ]{x}{1}}{right=2.5em of b}
      \event{d}{\DW{y}{1}}{right=of c}
      \event{e}{\DR[\mACQ]{y}{1}}{right=2.5em of d}
      \event{f}{\DW{x}{2}}{right=of e}
      \poloc{a}{b}
      \co[out=15,in=165]{b}{f}
      \rfx{b}{c}
      \fr[out=15,in=165]{c}[below]{f}
      \rfx[out=-165,in=-15]{f}{a}
    \end{tikzinline}}
  \\
  \tag{\xmark\armeight}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DR{x}{2}}{}
      \event{b}{\DW{x}{1}}{right=of a}
      \event{c}{\DR[\mACQ]{x}{1}}{right=2.5em of b}
      \event{d}{\DW{y}{1}}{right=of c}
      \event{e}{\DR[\mACQ]{y}{1}}{right=2.5em of d}
      \event{f}{\DW{x}{2}}{right=of e}
      \coe[out=165,in=15]{f}[above]{b}
      %\rfe[out=-165,in=-15]{f}{a}
      \bob{c}{d}
      \bob{e}{f}
      \rfe{b}{c}
      \rfe{d}{e}
    \end{tikzinline}}
\end{gather*}


\section{More Model}
These definitions need to be updated to include the additional orders.
\begin{definition}
  A pomset is \emph{$\aLoc$-closed} if
  \begin{itemize}
  \item every $\labelingAct(\aEv)=(\DR{\aLoc}{..})$ is fulfilled
  \item every $\labelingForm(\aEv)$ is independent of $x$:
    $\bigl(\forall v.\;\labelingForm(\aEv) \vDash
    \labelingForm(\aEv)[\aVal/\aLoc] \vDash \labelingForm(\aEv)\bigr)$
  \end{itemize}
\end{definition}

\begin{definition}
  Let $\aPS\phantom{'}\in(\nu\aLoc\!\DOT\!\aPSS) \mkern22mu$ when
  $\phantom{(\exists}\aPS\in\aPSS$ and $\aPS$ is $\aLoc$-closed
\end{definition}
\begin{definition}
  Let $\aPS\phantom{'}\in(\aForm \guard \aPSS)\mkern16mu$ when
  $\phantom{(\exists}\aPS\in\aPSS$ and $(\forall\aEv\in\Event)$
  $\labelingForm(\aEv)$ implies $\aForm$
\end{definition}

\begin{definition}
  Let $\aPS'\in(\aPSS[M/x])\mkern2mu$ when $(\exists\aPS\in\aPSS$)\\\qquad
  $\Event' = \Event$, ${\le'} = {\lehb}$, $\labelingAct' = \labelingAct$, and
  $(\forall\aEv\in\Event')$ $\labelingForm'(\aEv) = \labelingForm(\aEv)[M/x]$
\end{definition}
\begin{definition}
  Let $\aPS' \in (\aPSS^1 \parallel \aPSS^2)$ when
  $(\exists\aPS^1 \in \aPSS^1)$ $(\exists\aPS^2 \in \aPSS^2)$
  \\% $\aPS^1$ is completed exactly when $\aPS^2$ is completed, there is at most one termination in $\Event'$,
  \qquad $\Event' = \Event^1 \cup \Event^2$,
  ${\le'}\supseteq{\lehb^1}\cup{\lehb^2}$, and $(\forall\aEv\in\Event')$ either
  \begin{gather*}
    \begin{aligned}
      \aEv \not\in \Event^2,\; \labelingAct'(\aEv) &= \labelingAct^1(\aEv)
      \textand \labelingForm'(\aEv) \textimplies \labelingForm^1(\aEv),
      \\[-1ex]
      \aEv \not\in \Event^1,\; \labelingAct'(\aEv) &= \labelingAct^2(\aEv)
      \textand \labelingForm'(\aEv) \textimplies
      \labelingForm^2(\aEv),\textor
      \\[-1ex]
      \labelingAct'(\aEv) = \labelingAct^1(\aEv) &= \labelingAct^2(\aEv)
      \textand \labelingForm'(\aEv) \textimplies \labelingForm^1(\aEv) \lor
      \labelingForm^2(\aEv)
    \end{aligned}
  \end{gather*}
\end{definition}

Language
\begin{gather*}
  % \begin{aligned}
  %   \aCmd,\,\bCmd
  %   \BNFDEF& \SKIP
  %   \BNFSEP \aReg\GETS\aExp\SEMI \aCmd
  %   \BNFSEP \aReg\GETS\aLoc^{\amode}\SEMI \aCmd 
  %   \BNFSEP \aLoc^{\amode}\GETS\aExp\SEMI \aCmd
  %   \\[-.5ex]
  %   \BNFSEP&\aCmd \PAR[\aThrd][\bThrd] \bCmd
  %   \BNFSEP \VAR\aLoc\SEMI \aCmd
  %   \BNFSEP \IF{\aExp} \THEN \aCmd \ELSE \bCmd \FI
  % \end{aligned}
  % \\
  \begin{aligned}
    \sem[\aThrd]{\SKIP} & \eqdef
    \{ \DSTOP \}
    \\
    \sem[\aThrd]{\aReg\GETS\aExp\SEMI \aCmd} & \eqdef
    \sem[\aThrd]{\aCmd}[\aExp/\aReg]
    \\ 
    \sem{\aReg\GETS\aLoc^{\amode}\SEMI \aCmd} & \eqdef \textstyle\bigcup_\aVal\;
    (\DR[\amode]\aLoc\aVal)\prefix \sem{\aCmd} [\aLoc/\aReg]
    \\
    \sem{\aLoc^{\amode}\GETS\aExp\SEMI \aCmd} & \eqdef
    \textstyle\bigcup_\aVal\; (\aExp=\aVal \mid \DW[\amode]\aLoc\aVal)\prefix \sem{\aCmd}[\aExp/\aLoc]
    \\
    \sem{\FENCE^{\fmode}\SEMI \aCmd} & \eqdef
    (\DFS{\fmode}) \prefix \sem{\aCmd}
    \\
    \sem[\aThrd]{\IF{\aExp} \THEN \aCmd \ELSE \bCmd \FI} & \eqdef
    \bigl(\aExp \guard \sem[\aThrd]{\aCmd}\bigr) \parallel \bigl(\lnot\aExp \guard \sem[\aThrd]{\bCmd}\bigr) 
    \\
    \sem[\aThrd]{\aCmd \PAR[\bThrd][\bThrd'] \bCmd} & \eqdef
    \sem[\bThrd]{\aCmd} \parallel \sem[\bThrd']{\bCmd} 
    \\
    \sem[\aThrd]{\VAR\aLoc\SEMI \aCmd} & \eqdef
    \nu \aLoc \DOT \sem[\aThrd]{\aCmd}  
  \end{aligned}
\end{gather*}
\begin{align*}
  \fmode \BNFDEF&\mREL  &&\text{(Release)} &\hbox{$\;\mkern60mu\;$}&
  \\ \BNFSEP&\mACQ   &&\text{(Acquire)} 
  \\      \BNFSEP&\mSC  &&\text{(SC)} 
\end{align*}


A citation: \cite{10.1145/3428262}



